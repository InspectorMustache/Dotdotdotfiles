#!/bin/fish

function merge_config -a skel_file custom_file out_file
    test ! -e $skel_file; and return
    set -l skel_lines
    cat $skel_file | while read -l line
        set skel_lines $skel_lines $line
    end

    set -l custom_lines
    # if there's no custom_file, an empty custom_lines variable will just result in a copy of the skel_file, which is okay
    # however, this requires that the actual config file is not a symbolic link to the skel_file
    if test -e $custom_file
        cat $custom_file | while read -l line
            set custom_lines $custom_lines $line
        end
    end

    echo -n "" > $out_file
    for line in $skel_lines
        echo $line >> $out_file
        string match -qe '{{{custom}}}' $line; and begin
            string join \n $custom_lines >> $out_file
        end; or true # so this doesn't create an exit code of 1 even though nothing's wrong
    end
end

# run all configs that need to be merged together here
merge_config $HOME/.config/i3blocks/config.skel $HOME/.config/i3blocks/custom $HOME/.config/i3blocks/config
merge_config $HOME/.config/i3/config.skel $HOME/.config/i3/custom $HOME/.config/i3/config
